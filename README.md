# Активация гарантийного талона

Многошаговая форма для активации гарантии, сбора обратной связи и бронирования скидок.

## Технологии

- **Next.js 14** (App Router)
- **TypeScript**
- **React Hook Form** + **Zod** для валидации
- **Tailwind CSS** для стилей
- **React Input Mask** для маски телефона

## Установка и запуск

```bash
# Установка зависимостей
npm install

# Запуск в режиме разработки
npm run dev

# Сборка для продакшена
npm run build

# Запуск продакшен версии
npm start
```

Приложение будет доступно по адресу `http://localhost:3000`

## Структура проекта

```
/workspace
├── app/
│   ├── api/warranty/
│   │   ├── activate/route.ts    # API активации гарантии
│   │   └── status/route.ts       # API проверки статуса
│   ├── garantia/
│   │   ├── page.tsx              # Главная страница формы
│   │   └── success/page.tsx      # Страница успешной активации
│   ├── layout.tsx                # Корневой layout
│   └── globals.css               # Глобальные стили
├── components/
│   ├── WarrantyForm.tsx          # Основной компонент формы
│   ├── Input.tsx                 # Компоненты ввода
│   ├── RatingInput.tsx           # Компонент оценки (1-5)
│   ├── ExtraWorkInput.tsx        # Компонент доп. работ
│   ├── DiscountSelection.tsx     # Компонент выбора скидок
│   └── PrivacyCheckbox.tsx       # Чекбокс политики конфиденциальности
├── lib/
│   ├── schemas.ts                # Zod схемы валидации
│   └── utils.ts                  # Утилиты (localStorage, аналитика)
└── package.json
```

## Функциональность

### Шаги формы

1. **Идентификация** (обязательно)
   - Телефон: `+7 (___) ___-__-__`
   - Номер договора: `IL-xxxxxx` или `D-xxxxxx` или числовой (6-16 символов)

2. **Дополнительные работы** (необязательно)
   - Чекбокс "Да/Нет"
   - Динамический список работ с названием и ценой

3. **Работа продавцов** (необязательно)
   - Оценка 1-5 с подписями
   - Ссылка на Яндекс.Отзывы

4. **Работа доставки** (необязательно)
   - Оценка 1-5 с подписями
   - Ссылка на Яндекс.Отзывы

5. **Работа монтажников** (условно)
   - Показывается только если у договора есть монтаж
   - Определяется автоматически на основе номера договора

6. **Бронирование скидок**
   - Карточки товаров/услуг со скидками
   - Опция "Ничего не нужно" снимает все остальные
   - Чекбокс согласия с политикой конфиденциальности

### API Endpoints

#### POST `/api/warranty/activate`

Активация гарантии.

**Request Body:**
```json
{
  "phone_or_contract": "IL-123456",
  "has_extra_work": true,
  "extra_work": [{"title": "Порог", "price": 1500}],
  "rates": {
    "sales": 5,
    "delivery": 4,
    "installation": 5
  },
  "discounts": ["glue_10", "installation_30"]
}
```

**Response 200:**
```json
{
  "activated": true,
  "warranty_id": "W-2025-000987",
  "contract_id": "IL-123456",
  "discounts_reserved_until": "2025-11-13"
}
```

**Ошибки:**
- `400` - Ошибка валидации
- `404` - Договор/телефон не найден
- `409` - Гарантия уже активирована
- `429` - Превышен лимит запросов
- `500` - Внутренняя ошибка сервера

#### GET `/api/warranty/status?contract=IL-123456`

Проверка статуса активации гарантии.

**Response:**
```json
{
  "activated": true,
  "warranty_id": "W-2025-000987",
  "activated_at": "2025-01-01T12:00:00Z"
}
```

## Особенности реализации

### Валидация

- **Телефон**: маска `+7 (___) ___-__-__`, проверка формата E.164
- **Договор**: префиксы `IL-`, `D-` или числовой формат (6-16 символов)
- **Оценки**: integer 1-5 (необязательно)
- **Скидки**: массив кодов из допустимых значений

### Rate Limiting

- 5 попыток в час на IP-адрес
- Реализовано в памяти (для продакшена рекомендуется Redis)

### Сохранение драфта

- Автоматическое сохранение в `localStorage`
- Срок действия: 24 часа
- Очищается после успешной отправки

### Аналитика

События отслеживаются через `trackEvent()`:
- `warranty_start` - начало заполнения
- `id_step_completed` - завершение шага (1-6)
- `warranty_submit` - отправка формы
- `warranty_activated` - успешная активация
- `discount_selected` - выбор скидки
- `review_link_clicked` - клик по ссылке отзывов

Для интеграции Google Analytics 4 и Яндекс.Метрики добавьте скрипты в `layout.tsx`.

### Адаптивность

- Mobile-first подход
- Минимальная ширина: 360px
- Тач-оптимизация для рейтингов
- Прогресс-бар фиксирован сверху

## TODO / Интеграции

Для полноценной работы необходимо реализовать:

1. **Интеграция с БД/CRM**
   - Проверка существования договора
   - Сохранение активаций
   - Проверка статуса монтажа

2. **reCAPTCHA/Cloudflare Turnstile**
   - Добавить на шаг отправки формы

3. **SMS/Email уведомления**
   - Интеграция с SMS.ru, UniSender и т.д.
   - Шаблон подтверждения активации

4. **Интеграция с Яндекс.Отзывы**
   - Заменить заглушки на реальные URL

5. **Админ-панель**
   - Просмотр активаций
   - Управление скидками
   - Экспорт данных

6. **Изображения скидок**
   - Добавить изображения в `/public/images/`

## SEO

- `robots: { index: false, follow: false }` - форма не индексируется
- Канонический URL: `/garantia`
- OpenGraph мета-теги в `layout.tsx`

## Безопасность

- Server-side валидация всех данных
- Rate limiting по IP
- Нормализация телефонов и договоров
- Логирование аудита (IP, время активации)
- Защита ссылок (`rel="noopener noreferrer"`)

## Лицензия

Приватный проект.

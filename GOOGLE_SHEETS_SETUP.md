# Инструкция по настройке интеграции с Google Таблицами

Эта инструкция поможет вам настроить автоматическое сохранение данных из формы гарантии в Google Таблицы.

## Шаг 1: Создание Google Таблицы

1. Откройте [Google Таблицы](https://docs.google.com/spreadsheets/)
2. Создайте новую таблицу (нажмите "+ Создать")
3. Назовите таблицу, например: "Активации гарантии"
4. Создайте заголовки столбцов в первой строке:

| A | B | C | D | E | F | G | H | I | J | K | L | M | N |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| Дата и время | Телефон | Договор | Доп. работы | Описание работ | Стоимость работ | Оценка продавцов | Отзыв продавцы | Оценка доставки | Отзыв доставка | Оценка монтажников | Отзыв монтажники | Скидки | IP адрес |

5. Сохраните таблицу

## Шаг 2: Создание Google Apps Script

1. В открытой Google Таблице перейдите в меню: **Расширения** → **Apps Script**
2. Откроется редактор скриптов
3. Удалите весь существующий код
4. Скопируйте и вставьте следующий код:

```javascript
function doPost(e) {
  try {
    // Получаем активную таблицу
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    // Парсим данные из запроса
    var data = JSON.parse(e.postData.contents);
    
    // Создаем массив для новой строки
    var row = [
      data.timestamp || '',
      data.phone || '',
      data.contract || '',
      data.additional_work || '',
      data.work_descriptions || '',
      data.work_costs || '',
      data.sales_rating || '',
      data.sales_feedback || '',
      data.delivery_rating || '',
      data.delivery_feedback || '',
      data.installation_rating || '',
      data.installation_feedback || '',
      data.discounts || '',
      data.ip_address || ''
    ];
    
    // Добавляем строку в таблицу
    sheet.appendRow(row);
    
    // Возвращаем успешный ответ
    return ContentService.createTextOutput(JSON.stringify({
      'result': 'success',
      'row': sheet.getLastRow()
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch(error) {
    // В случае ошибки возвращаем информацию об ошибке
    return ContentService.createTextOutput(JSON.stringify({
      'result': 'error',
      'error': error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Функция для тестирования (необязательно)
function testPost() {
  var testData = {
    timestamp: '31.10.2025 15:30:00',
    phone: '+7 (999) 123-45-67',
    contract: '12345',
    additional_work: 'Да',
    work_descriptions: 'Укладка подложки',
    work_costs: '5000',
    sales_rating: '5',
    sales_feedback: '',
    delivery_rating: '5',
    delivery_feedback: '',
    installation_rating: '4',
    installation_feedback: 'Хорошо',
    discounts: 'Клей, Плинтус',
    ip_address: '192.168.1.1'
  };
  
  var e = {
    postData: {
      contents: JSON.stringify(testData)
    }
  };
  
  Logger.log(doPost(e).getContent());
}
```

5. Сохраните проект: **Файл** → **Сохранить** (или Ctrl+S)
6. Назовите проект, например: "Warranty Form Integration"

## Шаг 3: Развертывание Web App

1. В редакторе Apps Script нажмите кнопку **Развернуть** → **Новое развертывание**
2. Настройте параметры развертывания:
   - **Тип**: выберите "Веб-приложение"
   - **Описание**: введите "Интеграция формы гарантии" (опционально)
   - **Запускать как**: выберите "Я" (ваша учетная запись)
   - **У кого есть доступ**: выберите **"Все"** (важно!)
3. Нажмите **Развернуть**
4. При первом развертывании Google попросит авторизовать доступ:
   - Нажмите **Авторизовать доступ**
   - Выберите вашу учетную запись Google
   - Google может показать предупреждение "Это приложение не проверено" - это нормально для личных скриптов
   - Нажмите **Дополнительные настройки** → **Перейти на страницу "..." (небезопасно)**
   - Нажмите **Разрешить**
5. После успешного развертывания вы получите **URL веб-приложения**
6. **ВАЖНО**: Скопируйте этот URL! Он выглядит примерно так:
   ```
   https://script.google.com/macros/s/AKfycbz.../exec
   ```

## Шаг 4: Настройка в файле send-warranty.php

1. Откройте файл `send-warranty.php`
2. Найдите строку:
   ```php
   $google_sheets_url = "YOUR_GOOGLE_SCRIPT_URL_HERE";
   ```
3. Замените на ваш URL из Шага 3:
   ```php
   $google_sheets_url = "https://script.google.com/macros/s/AKfycbz.../exec";
   ```
4. Сохраните файл

## Шаг 5: Тестирование

### Тест через форму:
1. Откройте вашу форму гарантии на сайте
2. Заполните все поля
3. Отправьте форму
4. Проверьте Google Таблицу - должна появиться новая строка с данными

### Тест через Apps Script (опциональный):
1. В редакторе Apps Script выберите функцию `testPost` в выпадающем списке
2. Нажмите **Выполнить** (кнопка ▶)
3. Проверьте таблицу - должна добавиться тестовая строка

## Структура данных в таблице

Каждая строка содержит:
- **Дата и время** - когда была заполнена форма
- **Телефон** - номер телефона клиента
- **Договор** - номер договора
- **Доп. работы** - Да/Нет
- **Описание работ** - список дополнительных работ (через ";")
- **Стоимость работ** - стоимости работ (через ";")
- **Оценка продавцов** - рейтинг от 1 до 5
- **Отзыв продавцы** - текстовый отзыв (если оценка низкая)
- **Оценка доставки** - рейтинг от 1 до 5
- **Отзыв доставка** - текстовый отзыв (если оценка низкая)
- **Оценка монтажников** - рейтинг от 1 до 5
- **Отзыв монтажники** - текстовый отзыв (если оценка низкая)
- **Скидки** - выбранные скидки (через ",")
- **IP адрес** - IP адрес пользователя

## Возможные проблемы и решения

### Ошибка: "Доступ запрещен"
**Решение**: Проверьте, что в настройках развертывания выбрано "У кого есть доступ: **Все**"

### Данные не добавляются в таблицу
**Решение**: 
1. Проверьте правильность URL в `send-warranty.php`
2. Убедитесь, что URL заканчивается на `/exec`, а не `/dev`
3. Проверьте, что скрипт развернут (не в режиме тестирования)

### Ошибка авторизации
**Решение**:
1. Вернитесь в Apps Script
2. Создайте новое развертывание
3. Используйте новый URL

### Ошибка "Script function not found: doPost"
**Решение**: Убедитесь, что вы скопировали весь код из Шага 2 и сохранили его

### Таблица заполняется, но данные в неправильных столбцах
**Решение**: Проверьте порядок заголовков в первой строке таблицы - он должен точно соответствовать порядку из Шага 1

## Дополнительные возможности

### Форматирование данных
Вы можете отформатировать таблицу:
- Выделить заголовки жирным шрифтом
- Добавить фильтры: **Данные** → **Создать фильтр**
- Закрепить первую строку: **Вид** → **Закрепить** → **1 строку**
- Установить ширину столбцов для удобного просмотра

### Автоматические уведомления
Вы можете настроить уведомления при добавлении новой строки:
1. В редакторе Apps Script добавьте функцию отправки email
2. Вызовите её в конце функции `doPost`

### Несколько листов
Если хотите сохранять данные на конкретный лист:
```javascript
var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Название листа");
```

### Обновление развертывания
Если вы изменили код скрипта:
1. Нажмите **Развернуть** → **Управление развертываниями**
2. Нажмите на иконку редактирования ✏️
3. Измените **Версия** на "Новая версия"
4. Нажмите **Развернуть**
5. URL останется прежним

## Безопасность

- URL веб-приложения является публичным, но он уникален и сложен для угадывания
- Рекомендуется хранить URL в безопасном месте
- Регулярно проверяйте таблицу на наличие подозрительной активности
- При необходимости можно создать новое развертывание с новым URL

## Отключение интеграции

Если хотите временно отключить сохранение в Google Таблицы:
1. В `send-warranty.php` закомментируйте или измените строку:
   ```php
   // $google_sheets_url = "YOUR_GOOGLE_SCRIPT_URL_HERE";
   ```
   или верните на значение по умолчанию:
   ```php
   $google_sheets_url = "YOUR_GOOGLE_SCRIPT_URL_HERE";
   ```

---

**Готово!** Теперь все данные из формы будут автоматически сохраняться в вашу Google Таблицу! 📊
